<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye Drop Admin Dashboard</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f4f6f8;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #0f172a;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f8fafc;
            color: #64748b;
            font-weight: 600;
        }

        tr:hover {
            background: #f1f5f9;
        }

        .status-active {
            color: #16a34a;
            font-weight: bold;
        }

        .status-inactive {
            color: #dc2626;
            font-weight: bold;
        }

        button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 5px;
        }

        .btn-stop {
            background: #fecaca;
            color: #991b1b;
        }

        .btn-start {
            background: #bbf7d0;
            color: #166534;
        }

        .btn-delete {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-refresh {
            background: #3b82f6;
            color: white;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>Admin Dashboard</h1>
            <div>
                <button class="btn-refresh" onclick="fetchReminders()">&#x21bb; Refresh List</button>
                <button class="btn-stop" style="background:#64748b; color:white; margin-left:10px;"
                    onclick="logout()">Logout</button>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Patient Name</th>
                    <th>Contact</th>
                    <th>Interval</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="reminderTable">
                <!-- Data here -->
            </tbody>
        </table>

        <!-- Users Section -->
        <h2 style="margin-top: 40px;">Registered Users</h2>
        <table>
            <thead>
                <tr>
                    <th>User Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Joined</th>
                </tr>
            </thead>
            <tbody id="usersTable">
                <!-- User Data -->
            </tbody>
        </table>
    </div>

    <script>
        // --- AUTH CHECK ---
        if (localStorage.getItem('auth_token') !== 'valid_admin_token') {
            window.location.href = 'login.html';
        }

        function logout() {
            localStorage.removeItem('auth_token');
            window.location.href = 'index.html';
        }
        // ------------------

        const API_URL = '/api/admin/reminders';



        async function toggle(id, isActive) {
            const res = await fetch(API_URL + '/' + id + '/toggle', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ isActive })
            });
            if (!res.ok) alert('Failed to update status');
            fetchAllData();
        }

        async function remove(id) {
            if (!confirm('Are you sure you want to delete this reminder permanently?')) return;
            const res = await fetch(API_URL + '/' + id, { method: 'DELETE' });
            if (!res.ok) alert('Failed to delete');
            fetchAllData();
        }

        // Initial Load
        let globalReminders = [];

        async function fetchAllData() {
            await fetchReminders();
            await fetchUsers();
        }
        fetchAllData();

        async function fetchReminders() {
            const tbody = document.getElementById('reminderTable');
            tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';

            try {
                const res = await fetch(API_URL);
                globalReminders = await res.json(); // Store for User Status check

                tbody.innerHTML = '';
                if (globalReminders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No active reminders found.</td></tr>';
                    return;
                }

                globalReminders.forEach(rem => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${rem.patientName}</td>
                    <td>
                        Is: ${rem.email || '-'} <br/>
                        Ph: ${rem.phone || '-'}
                    </td>
                    <td>Every ${rem.intervalHours}h</td>
                    <td><span class="${rem.isActive ? 'status-active' : 'status-inactive'}">${rem.isActive ? 'ACTIVE' : 'STOPPED'}</span></td>
                    <td>
                        ${rem.isActive
                            ? `<button class="btn-stop" onclick="toggle('${rem._id}', false)">Stop</button>`
                            : `<button class="btn-start" onclick="toggle('${rem._id}', true)">Start</button>`
                        }
                        <button class="btn-delete" onclick="remove('${rem._id}')">Delete</button>
                    </td>
                `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="5" style="color:red">Error loading data: ${err.message}. Is server running?</td></tr>`;
            }
        }
        fetchUsers();

        async function fetchUsers() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
            try {
                const res = await fetch('/api/admin/users');
                const users = await res.json();

                tbody.innerHTML = '';
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No registered users found.</td></tr>';
                    return;
                }

                users.forEach(u => {
                    // Check if this user has any active reminder
                    const hasActive = globalReminders.some(r => r.email === u.email && r.isActive);
                    const statusHtml = hasActive
                        ? '<span class="status-active">Active</span>'
                        : '<span style="color:#94a3b8">No Reminder</span>';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td>${u.phone}</td>
                        <td>${statusHtml}</td>
                        <td>${new Date(u.createdAt).toLocaleDateString()}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5" style="color:red">Error loading users.</td></tr>';
            }
        }
    </script>

</body>

</html>